<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MatchSticks â€” Digital Cigar Sommelier</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo">ðŸ”¥</div>
      <div class="titles">
        <h1>MatchSticks</h1>
        <p>Find cigars like your favorites</p>
      </div>
    </div>
  </header>
<!-- === Cigar Recommender (Drop-in) === -->
<section class="recs" style="max-width:620px;margin:24px auto;font-family:system-ui, -apple-system, Segoe UI, Roboto;">
  <label for="cigarInput" style="display:block;font-weight:600;margin-bottom:6px;">Enter a cigar</label>
  <div style="display:flex; gap:8px;">
    <input id="cigarInput" type="text" placeholder="e.g., Padron 1964 Anniversary"
           style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px" />
    <button id="goBtn" type="button"
            style="padding:10px 14px;border:0;border-radius:8px;background:#222;color:#fff;cursor:pointer">
      Get 3 recs
    </button>
  </div>

  <div id="status" style="margin-top:10px;color:#666;"></div>

  <div id="results" style="margin-top:14px;display:grid;gap:10px;"></div>

  <details style="margin-top:14px;">
    <summary style="cursor:pointer;">Debug</summary>
    <pre id="debug" style="background:#111;color:#9fe;border-radius:8px;padding:10px;overflow:auto;max-height:220px;"></pre>
  </details>
</section>

<script>
(function(){
  const input   = document.getElementById('cigarInput');
  const btn     = document.getElementById('goBtn');
  const status  = document.getElementById('status');
  const results = document.getElementById('results');
  const debugEl = document.getElementById('debug');

  const log = (...args) => {
    console.log(...args);
    const line = args.map(a => {
      try { return typeof a === 'string' ? a : JSON.stringify(a,null,2); }
      catch { return String(a); }
    }).join(' ');
    debugEl.textContent += line + '\n';
  };

  async function getRecs() {
    const cigar = (input.value || '').trim();
    results.innerHTML = '';
    status.textContent = 'Workingâ€¦';
    log('Click fired. Cigar:', cigar);

    if (!cigar) {
      status.textContent = 'Please enter a cigar.';
      return;
    }

    try {
      const res = await fetch('/.netlify/functions/recommend', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ cigar })
      });

      const text = await res.text();           // read raw text for better error visibility
      log('HTTP', res.status, res.statusText);
      log('Raw response:', text);

      let data = {};
      try { data = JSON.parse(text); } catch (e) { /* keep data as {} */ }

      if (!res.ok) {
        status.textContent = data?.error || ('Request failed: ' + res.status);
        return;
      }

      const items = data?.recommendations;
      if (!Array.isArray(items) || items.length === 0) {
        status.textContent = 'No recommendations returned.';
        return;
      }

      status.textContent = 'Done.';
      results.innerHTML = items.map(it => `
        <div style="border:1px solid #ddd;padding:12px;border-radius:10px">
          <div style="font-weight:700">${it.name ?? ''}</div>
          <div style="color:#555">${it.brand ?? ''}</div>
          <div style="margin-top:6px">Price: ${it.priceRange ?? ''} â€¢ Strength: ${it.strength ?? ''}</div>
          <div style="color:#444;margin-top:6px">${Array.isArray(it.flavorNotes) ? it.flavorNotes.join(', ') : ''}</div>
        </div>
      `).join('');

    } catch (err) {
      log('Fetch error:', err);
      status.textContent = 'Network error (see Debug).';
    }
  }

  // Button click
  btn.addEventListener('click', getRecs);

  // Enter key in input
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();   // stop accidental form submit
      getRecs();
    }
  });

  // Safety: if this lives inside a <form>, prevent full reload on submit
  let node = input;
  while (node) {
    if (node.tagName === 'FORM') {
      node.addEventListener('submit', (e) => { e.preventDefault(); getRecs(); });
      break;
    }
    node = node.parentElement;
  }
})();
</script>
<!-- === End drop-in === -->

  <main class="container">
    <section class="panel">
      <label for="cigar" class="label">Enter a cigar</label>
      <div class="row">
        <input id="cigar" type="text" placeholder="e.g., Padron 1964, Opus X, Montecristo No. 2" />
        <button id="go">Find Matches</button>
      </div>
      <p id="hint" class="hint"></p>
      <div id="status" class="status" aria-live="polite"></div>
    </section>

    <section id="results" class="results" hidden>
      <h2>Recommendations</h2>
      <div id="cards" class="cards"></div>
    </section>
  </main>

  <footer class="footer">
    <small>Â© <span id="year"></span> MatchSticks</small>
  </footer>

  <script src="app.js"></script>
</body>
</html>
